{% extends 'base.html' %}

{% block content %}

<div class="event-details">
  <h2>{{ event.name }}</h2>
  <p>Date: {{ event.date }}</p>
  <p>Time: {{ event.time }}</p>
  <p>Location: {{ event.location }}</p>
  <p>Description: {{ event.description }}</p>
  <p>Cost: {{ event.cost }}</p>

  {% if request.user in event.attendees.all %}
  <form action="{% url 'cancel_attend' event.id %}" method="post">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">Cancel Attending</button>
  </form>
  {% else %}
  <form action="{% url 'attend' event.id %}" method="post">
    {% csrf_token %}
    <button type="submit" class="btn btn-primary">Attend</button>
  </form>
  <div class="invite-section">
    <h3>Invite Friends:</h3>
    <form id="invite-form" method="post">
      {% csrf_token %}
      <input type="text" id="search-input" placeholder="Search for users">
      <ul id="search-results"></ul>
      <button type="submit" class="btn btn-success">Send Invite</button>
    </form>
  </div>
  {% endif %}
</div>

<div class="attendees-list">
  <h3>Attendees:</h3>
  <ul>
    {% for attendee in event.attendees.all %}
    <li>{{ attendee.username }}</li>
    {% endfor %}
  </ul>
</div>

<div class="share-link-box">
  <h3>Shareable Link:</h3>
  <input
    type="text"
    id="shareable-link"
    value="{% url 'join_event' invitation_id=event.id %}"
    readonly
  />
  <button onclick="copyLink()" class="btn btn-primary">Copy Link</button>
</div>

<script>
  // AJAX live search
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const inviteForm = document.getElementById('invite-form');

  searchInput.addEventListener('input', () => {
    const searchTerm = searchInput.value.trim();

    if (searchTerm === '') {
      searchResults.innerHTML = '';
      return;
    }

    fetch(`/search/?q=${searchTerm}`)
      .then(response => response.json())
      .then(data => {
        searchResults.innerHTML = '';
        data.forEach(user => {
          const listItem = document.createElement('li');
          listItem.textContent = user.username;
          listItem.dataset.userId = user.id;
          searchResults.appendChild(listItem);
        });
      });
  });

  inviteForm.addEventListener('submit', (event) => {
    event.preventDefault();

    const selectedUsers = Array.from(searchResults.querySelectorAll('li')).filter(li => li.classList.contains('selected'));
    const selectedUserIds = selectedUsers.map(li => li.dataset.userId);

    // Send the selected user ids to the server for invitation
    // You can use AJAX here to send the selected user ids to the server
  });

  searchResults.addEventListener('click', (event) => {
    const listItem = event.target;
    if (listItem.tagName === 'LI') {
      listItem.classList.toggle('selected');
    }
  });
</script>

{% endblock %}
